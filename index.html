<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Decryption</title>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        video {
            width: 300px;
            margin: 10px auto;
            display: block;
        }
        input {
            margin-top: 10px;
        }
        #result {
            margin-top: 20px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>QR Code Decryption</h1>

    <!-- Video for live scanning -->
    <video id="video" autoplay playsinline></video>

    <p>or</p>

    <!-- File upload for QR code image -->
    <input type="file" id="fileInput" accept="image/*">

    <div id="result">Decrypted Data: <span id="decryptedData"></span></div>

    <script>
        const key = CryptoJS.enc.Utf8.parse("shrunk4life12345"); // Use the same key as in encryption
        const video = document.getElementById("video");
        const resultElement = document.getElementById("decryptedData");
        const fileInput = document.getElementById("fileInput");
        let videoStream = null;

        // AES decryption function (ECB mode)
        function decryptData(encryptedData, key) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, key, {
                    mode: CryptoJS.mode.ECB,
                    padding: CryptoJS.pad.Pkcs7
                });
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error("Decryption error:", error);
                return "Invalid decryption key or corrupted data.";
            }
        }

        // Decode QR code from video frame
        function decodeQRCode(imageData) {
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            return code ? code.data : null;
        }

        // Validate if the decrypted string is a URL
        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Start video for live QR code scanning
        async function startVideo() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = videoStream;

                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                video.addEventListener("play", () => {
                    const scanInterval = setInterval(() => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        const encryptedData = decodeQRCode(imageData);
                        if (encryptedData) {
                            clearInterval(scanInterval);

                            const decryptedData = decryptData(encryptedData, key);
                            resultElement.textContent = decryptedData;

                            if (isValidURL(decryptedData)) {
                                window.location.href = decryptedData;
                            }

                            // Stop video stream after successful scan
                            videoStream.getTracks().forEach(track => track.stop());
                        }
                    }, 500);
                });
            } catch (err) {
                console.error("Error accessing video stream:", err);
            }
        }

        // Handle QR code image upload
        fileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");

                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        const encryptedData = decodeQRCode(imageData);
                        if (encryptedData) {
                            const decryptedData = decryptData(encryptedData, key);
                            resultElement.textContent = decryptedData;

                            if (isValidURL(decryptedData)) {
                                window.location.href = decryptedData;
                            }
                        } else {
                            resultElement.textContent = "No QR code found.";
                        }
                    };
                    img.src = reader.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Start live QR code scanning
        startVideo();
    </script>
</body>
</html>
